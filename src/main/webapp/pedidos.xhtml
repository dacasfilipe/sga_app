<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Gerenciamento de Pedidos - SGA</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <h:outputStylesheet library="css" name="style.css"/>
</h:head>

<h:body>
    <div class="layout-wrapper">
        <!-- Header -->
        <div class="layout-topbar">
            <div class="layout-topbar-logo">
                <h:link outcome="index">
                    <i class="pi pi-home"></i>
                    <span>SGA - Pedidos</span>
                </h:link>
            </div>
            <div class="layout-topbar-menu">
                <h:link outcome="index" styleClass="topbar-link">
                    <i class="pi pi-home"></i>
                    <span>Início</span>
                </h:link>
                <h:link outcome="categorias" styleClass="topbar-link">
                    <i class="pi pi-tags"></i>
                    <span>Categorias</span>
                </h:link>
                <h:link outcome="produtos" styleClass="topbar-link">
                    <i class="pi pi-box"></i>
                    <span>Produtos</span>
                </h:link>
                <h:link outcome="clientes" styleClass="topbar-link">
                    <i class="pi pi-user"></i>
                    <span>Clientes</span>
                </h:link>
                <h:link outcome="usuarios" styleClass="topbar-link">
                    <i class="pi pi-users"></i>
                    <span>Usuários</span>
                </h:link>
            </div>
        </div>

        <!-- Main Content -->
        <div class="layout-main">
            <div class="layout-content">
                <div class="card">
                    <h1>
                        <i class="pi pi-shopping-cart"></i>
                        Gerenciamento de Pedidos
                    </h1>

                    <p:messages id="messages" showDetail="true" closable="true"/>

                    <!-- Toolbar -->
                    <p:toolbar styleClass="toolbar-actions">
                        <p:toolbarGroup align="left">
                            <p:commandButton value="Novo Pedido" 
                                           icon="pi pi-plus" 
                                           styleClass="p-button-success"
                                           action="#{pedidoController.prepararNovo}"
                                           update="dialogCadastro"
                                           oncomplete="PF('dialogCadastro').show()"/>
                        </p:toolbarGroup>
                        
                        <p:toolbarGroup align="right">
                            <p:selectOneMenu value="#{pedidoController.filtroStatus}" 
                                           styleClass="search-input">
                                <f:selectItems value="#{pedidoController.statusSelectItems}"/>
                            </p:selectOneMenu>
                            <p:commandButton value="Filtrar" 
                                           icon="pi pi-search"
                                           action="#{pedidoController.pesquisar}"
                                           update="tabelaPedidos"
                                           styleClass="p-button-info"/>
                            <p:commandButton value="Limpar" 
                                           icon="pi pi-times"
                                           action="#{pedidoController.limparFiltro}"
                                           update="tabelaPedidos"
                                           styleClass="p-button-secondary"/>
                        </p:toolbarGroup>
                    </p:toolbar>

                    <!-- Tabela de Pedidos -->
                    <p:dataTable id="tabelaPedidos" 
                               value="#{pedidoController.pedidos}" 
                               var="pedido"
                               selection="#{pedidoController.pedidoSelecionado}"
                               selectionMode="single"
                               rowKey="#{pedido.id}"
                               paginator="true" 
                               rows="10"
                               paginatorPosition="bottom"
                               emptyMessage="Nenhum pedido encontrado."
                               styleClass="data-table">
                        
                        <p:column headerText="ID" sortBy="#{pedido.id}" width="80">
                            <h:outputText value="#{pedido.id}"/>
                        </p:column>

                        <p:column headerText="Cliente" sortBy="#{pedido.cliente.nome}">
                            <h:outputText value="#{pedido.cliente.nome}"/>
                        </p:column>

                        <p:column headerText="Data Pedido" sortBy="#{pedido.dataPedido}" width="120">
                            <h:outputText value="#{pedido.dataPedido}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Status" sortBy="#{pedido.status}" width="120">
                            <p:tag value="#{pedido.status}" 
                                   severity="#{pedido.status == 'Entregue' ? 'success' : 
                                             pedido.status == 'Cancelado' ? 'danger' : 
                                             pedido.status == 'Enviado' ? 'info' : 'warning'}"/>
                        </p:column>

                        <p:column headerText="Valor Total" sortBy="#{pedido.valorTotal}" width="120">
                            <h:outputText value="#{pedido.valorTotal}">
                                <f:convertNumber type="currency" currencySymbol="R$ "/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Ações" width="200">
                            <p:commandButton icon="pi pi-eye" 
                                           title="Visualizar"
                                           styleClass="p-button-info p-button-sm"
                                           action="#{pedidoController.prepararDetalhes}"
                                           update="dialogDetalhes"
                                           oncomplete="PF('dialogDetalhes').show()">
                                <f:setPropertyActionListener target="#{pedidoController.pedidoSelecionado}" 
                                                           value="#{pedido}"/>
                            </p:commandButton>
                            
                            <p:commandButton icon="pi pi-pencil" 
                                           title="Editar"
                                           styleClass="p-button-warning p-button-sm"
                                           action="#{pedidoController.prepararEdicao}"
                                           update="dialogCadastro"
                                           oncomplete="PF('dialogCadastro').show()">
                                <f:setPropertyActionListener target="#{pedidoController.pedidoSelecionado}" 
                                                           value="#{pedido}"/>
                            </p:commandButton>
                            
                            <p:commandButton icon="pi pi-trash" 
                                           title="Excluir"
                                           styleClass="p-button-danger p-button-sm"
                                           action="#{pedidoController.prepararExclusao}"
                                           update="dialogConfirmacao"
                                           oncomplete="PF('dialogConfirmacao').show()">
                                <f:setPropertyActionListener target="#{pedidoController.pedidoSelecionado}" 
                                                           value="#{pedido}"/>
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="layout-footer">
            <span>Sistema de Gerenciamento de Armazém - Pedidos</span>
        </div>
    </div>

    <!-- Dialog de Cadastro/Edição -->
    <p:dialog id="dialogCadastro" 
              header="#{pedidoController.pedido.id == null ? 'Novo Pedido' : 'Editar Pedido'}"
              widgetVar="dialogCadastro" 
              modal="true" 
              resizable="false"
              width="900"
              height="600"
              showEffect="fade" 
              hideEffect="fade">
        
        <h:form id="formCadastro">
            <p:panelGrid columns="2" styleClass="form-grid">
                <p:outputLabel for="cliente" value="Cliente:"/>
                <p:selectOneMenu id="cliente" 
                               value="#{pedidoController.pedido.cliente}" 
                               required="true"
                               requiredMessage="Cliente é obrigatório"
                               converter="omnifaces.SelectItemsConverter"
                               styleClass="form-input">
                    <f:selectItems value="#{pedidoController.clientesSelectItems}"/>
                </p:selectOneMenu>

                <p:outputLabel for="status" value="Status:"/>
                <p:selectOneMenu id="status" 
                               value="#{pedidoController.pedido.status}" 
                               required="true"
                               requiredMessage="Status é obrigatório"
                               styleClass="form-input">
                    <f:selectItem itemLabel="Pendente" itemValue="Pendente"/>
                    <f:selectItem itemLabel="Processando" itemValue="Processando"/>
                    <f:selectItem itemLabel="Enviado" itemValue="Enviado"/>
                    <f:selectItem itemLabel="Entregue" itemValue="Entregue"/>
                    <f:selectItem itemLabel="Cancelado" itemValue="Cancelado"/>
                </p:selectOneMenu>
            </p:panelGrid>

            <h3>Itens do Pedido</h3>
            
            <!-- Formulário para adicionar item -->
            <p:fieldset legend="Adicionar Item" styleClass="item-fieldset">
                <p:panelGrid columns="4" styleClass="form-grid">
                    <p:outputLabel for="produto" value="Produto:"/>
                    <p:selectOneMenu id="produto" 
                                   value="#{pedidoController.novoItem.produto}" 
                                   converter="omnifaces.SelectItemsConverter"
                                   styleClass="form-input">
                        <f:selectItems value="#{pedidoController.produtosSelectItems}"/>
                    </p:selectOneMenu>

                    <p:outputLabel for="quantidade" value="Quantidade:"/>
                    <p:inputNumber id="quantidade" 
                                 value="#{pedidoController.novoItem.quantidade}" 
                                 decimalPlaces="0"
                                 minValue="1"
                                 styleClass="form-input"/>
                </p:panelGrid>
                
                <p:commandButton value="Adicionar Item" 
                               icon="pi pi-plus"
                               action="#{pedidoController.adicionarItem}"
                               update="tabelaItens messages valorTotal"
                               styleClass="p-button-success"/>
            </p:fieldset>

            <!-- Tabela de itens -->
            <p:dataTable id="tabelaItens" 
                       value="#{pedidoController.pedido.itens}" 
                       var="item"
                       emptyMessage="Nenhum item adicionado."
                       styleClass="data-table">
                
                <p:column headerText="Produto">
                    <h:outputText value="#{item.produto.nome}"/>
                </p:column>

                <p:column headerText="Quantidade" width="100">
                    <h:outputText value="#{item.quantidade}"/>
                </p:column>

                <p:column headerText="Preço Unit." width="120">
                    <h:outputText value="#{item.precoUnitario}">
                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                    </h:outputText>
                </p:column>

                <p:column headerText="Subtotal" width="120">
                    <h:outputText value="#{item.subtotal}">
                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                    </h:outputText>
                </p:column>

                <p:column headerText="Ações" width="80">
                    <p:commandButton icon="pi pi-trash" 
                                   title="Remover"
                                   styleClass="p-button-danger p-button-sm"
                                   action="#{pedidoController.removerItem(item)}"
                                   update="tabelaItens messages valorTotal"/>
                </p:column>
            </p:dataTable>

            <!-- Valor Total -->
            <div class="total-section">
                <h:outputText id="valorTotal" 
                            value="Total: #{pedidoController.valorTotalPedido}" 
                            styleClass="total-value">
                    <f:convertNumber type="currency" currencySymbol="R$ "/>
                </h:outputText>
            </div>

            <div class="dialog-buttons">
                <p:commandButton value="Salvar" 
                               icon="pi pi-check"
                               action="#{pedidoController.salvar}"
                               update="messages tabelaPedidos"
                               oncomplete="if (args.validationFailed) { return; } PF('dialogCadastro').hide();"
                               styleClass="p-button-success"/>
                
                <p:commandButton value="Cancelar" 
                               icon="pi pi-times"
                               action="#{pedidoController.cancelar}"
                               oncomplete="PF('dialogCadastro').hide()"
                               immediate="true"
                               styleClass="p-button-secondary"/>
            </div>
        </h:form>
    </p:dialog>

    <!-- Dialog de Detalhes -->
    <p:dialog id="dialogDetalhes" 
              header="Detalhes do Pedido ##{pedidoController.pedidoSelecionado.id}"
              widgetVar="dialogDetalhes" 
              modal="true" 
              resizable="false"
              width="700"
              showEffect="fade" 
              hideEffect="fade">
        
        <h:form id="formDetalhes">
            <p:panelGrid columns="2" styleClass="form-grid">
                <p:outputLabel value="Cliente:"/>
                <h:outputText value="#{pedidoController.pedidoSelecionado.cliente.nome}"/>

                <p:outputLabel value="Data do Pedido:"/>
                <h:outputText value="#{pedidoController.pedidoSelecionado.dataPedido}">
                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                </h:outputText>

                <p:outputLabel value="Status:"/>
                <p:tag value="#{pedidoController.pedidoSelecionado.status}" 
                       severity="#{pedidoController.pedidoSelecionado.status == 'Entregue' ? 'success' : 
                                 pedidoController.pedidoSelecionado.status == 'Cancelado' ? 'danger' : 
                                 pedidoController.pedidoSelecionado.status == 'Enviado' ? 'info' : 'warning'}"/>

                <p:outputLabel value="Valor Total:"/>
                <h:outputText value="#{pedidoController.pedidoSelecionado.valorTotal}" styleClass="total-value">
                    <f:convertNumber type="currency" currencySymbol="R$ "/>
                </h:outputText>
            </p:panelGrid>

            <h3>Itens do Pedido</h3>
            <p:dataTable value="#{pedidoController.pedidoSelecionado.itens}" 
                       var="item"
                       styleClass="data-table">
                
                <p:column headerText="Produto">
                    <h:outputText value="#{item.produto.nome}"/>
                </p:column>

                <p:column headerText="Quantidade" width="100">
                    <h:outputText value="#{item.quantidade}"/>
                </p:column>

                <p:column headerText="Preço Unit." width="120">
                    <h:outputText value="#{item.precoUnitario}">
                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                    </h:outputText>
                </p:column>

                <p:column headerText="Subtotal" width="120">
                    <h:outputText value="#{item.subtotal}">
                        <f:convertNumber type="currency" currencySymbol="R$ "/>
                    </h:outputText>
                </p:column>
            </p:dataTable>

            <div class="dialog-buttons">
                <p:commandButton value="Fechar" 
                               icon="pi pi-times"
                               oncomplete="PF('dialogDetalhes').hide()"
                               immediate="true"
                               styleClass="p-button-secondary"/>
            </div>
        </h:form>
    </p:dialog>

    <!-- Dialog de Confirmação de Exclusão -->
    <p:dialog id="dialogConfirmacao" 
              header="Confirmar Exclusão"
              widgetVar="dialogConfirmacao" 
              modal="true" 
              resizable="false"
              width="400"
              showEffect="fade" 
              hideEffect="fade">
        
        <h:form id="formConfirmacao">
            <div class="confirmation-content">
                <i class="pi pi-exclamation-triangle confirmation-icon"></i>
                <span>Tem certeza que deseja excluir o pedido ##{pedidoController.pedidoSelecionado.id}?</span>
                <br/>
                <small>Esta ação irá reverter o estoque dos produtos.</small>
            </div>

            <div class="dialog-buttons">
                <p:commandButton value="Sim, Excluir" 
                               icon="pi pi-check"
                               action="#{pedidoController.confirmarExclusao}"
                               update="messages tabelaPedidos"
                               oncomplete="PF('dialogConfirmacao').hide()"
                               styleClass="p-button-danger"/>
                
                <p:commandButton value="Cancelar" 
                               icon="pi pi-times"
                               action="#{pedidoController.cancelar}"
                               oncomplete="PF('dialogConfirmacao').hide()"
                               immediate="true"
                               styleClass="p-button-secondary"/>
            </div>
        </h:form>
    </p:dialog>
</h:body>
</html>

